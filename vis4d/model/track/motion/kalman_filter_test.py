"""Test cases for kalman filter."""
import unittest

import torch

from .kalman_filter import KalmanFilter


class TestKalmanFilter(unittest.TestCase):
    """Test cases for kalman filter."""

    def test_kalman(self) -> None:
        """Test cases for kalman filter."""
        kf_motion_mat = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0],
                [0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
            ]
        )
        kf_update_mat = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
            ]
        )
        cov_motion_q = torch.Tensor(
            [
                [
                    1.3052e02,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    8.1574e01,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    1.4815e-01,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    1.8926e02,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    1.3052e02,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    8.1574e01,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    1.4815e-01,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    1.8926e02,
                ],
            ]
        )
        cov_project_r = torch.Tensor(
            [
                [1.1569e01, 0.0000e00, 0.0000e00, 0.0000e00],
                [0.0000e00, 7.9620e00, 0.0000e00, 0.0000e00],
                [0.0000e00, 0.0000e00, 2.9381e-02, 0.0000e00],
                [0.0000e00, 0.0000e00, 0.0000e00, 3.4189e01],
            ]
        )
        cov_p0 = torch.Tensor(
            [
                [
                    8.6435e04,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    7.0400e03,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    5.9936e-01,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    5.3149e03,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    7.4345e02,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    6.2898e01,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    8.3340e-02,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    1.7052e02,
                ],
            ]
        )

        kf = KalmanFilter(
            kf_motion_mat,
            kf_update_mat,
            cov_motion_q,
            cov_project_r,
            cov_p0,
        )

        det_box = torch.Tensor([979.5134, 545.2235, 1.3536, 193.0835])
        new_pos = torch.Tensor([975.5881, 539.7464, 1.3721, 185.2137])

        mean_init, covariance_init = kf.initiate(det_box)

        self.assertTrue(
            abs(
                (
                    mean_init
                    - torch.Tensor(
                        [
                            979.5134,
                            545.2235,
                            1.3536,
                            193.0835,
                            0.0000,
                            0.0000,
                            0.0000,
                            0.0000,
                        ]
                    )
                ).sum()
            )
            < 1
        )
        self.assertTrue(
            abs(
                (
                    covariance_init
                    - torch.Tensor(
                        [
                            [
                                8.6435e04,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                7.0400e03,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                5.9936e-01,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                5.3149e03,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                7.4345e02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                6.2898e01,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                8.3340e-02,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                1.7052e02,
                            ],
                        ]
                    )
                ).sum()
            )
            < 1
        )

        mean_predict, covariance_predict = kf.predict(
            mean_init, covariance_init
        )
        self.assertTrue(
            abs(
                (
                    mean_predict
                    - torch.Tensor(
                        [
                            979.5134,
                            545.2235,
                            1.3536,
                            193.0835,
                            0.0000,
                            0.0000,
                            0.0000,
                            0.0000,
                        ]
                    )
                ).sum()
            )
            < 1
        )
        self.assertTrue(
            abs(
                (
                    covariance_predict
                    - torch.Tensor(
                        [
                            [
                                8.7309e04,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                7.4345e02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                7.1845e03,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                6.2898e01,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                8.3085e-01,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                8.3340e-02,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                5.6747e03,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                1.7052e02,
                            ],
                            [
                                7.4345e02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                8.7397e02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                6.2898e01,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                1.4447e02,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                8.3340e-02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                2.3149e-01,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                1.7052e02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                3.5978e02,
                            ],
                        ]
                    )
                ).sum()
            )
            < 1
        )

        mean_update, covariance_update = kf.update(
            mean_predict,
            covariance_predict,
            new_pos,
        )
        self.assertTrue(
            abs(
                (
                    mean_update
                    - torch.Tensor(
                        [
                            9.7559e02,
                            5.3975e02,
                            1.3715e00,
                            1.8526e02,
                            -3.3420e-02,
                            -4.7897e-02,
                            1.7994e-03,
                            -2.3506e-01,
                        ]
                    )
                ).sum()
            )
            < 1
        )
        self.assertTrue(
            abs(
                (
                    covariance_update
                    - torch.Tensor(
                        [
                            [
                                1.1586e01,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                9.8633e-02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                7.9541e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                6.9637e-02,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                2.8378e-02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                2.8465e-03,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                3.3984e01,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                1.0212e00,
                            ],
                            [
                                9.8633e-02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                8.6765e02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                6.9637e-02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                1.4392e02,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                2.8465e-03,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                2.2341e-01,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                1.0212e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                3.5469e02,
                            ],
                        ]
                    )
                ).sum()
            )
            < 1
        )
