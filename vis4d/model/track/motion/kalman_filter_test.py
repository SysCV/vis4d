"""Test cases for kalman filter."""
import unittest

import torch

from .kalman_filter import KalmanFilter


class TestKalmanFilter(unittest.TestCase):
    """Test cases for kalman filter."""

    def test_kalman(self) -> None:
        """Test cases for kalman filter."""
        kf_motion_mat = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0],
                [0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
            ]
        )
        kf_update_mat = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
            ]
        )
        cov_motion_q = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
            ]
        )
        cov_project_r = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0],
                [0.0, 2.0, 0.0, 0.0],
                [0.0, 0.0, 3.0, 0.0],
                [0.0, 0.0, 0.0, 4.0],
            ]
        )
        cov_p0 = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
            ]
        )

        kf = KalmanFilter(
            kf_motion_mat,
            kf_update_mat,
            cov_motion_q,
            cov_project_r,
            cov_p0,
        )

        det_box = torch.Tensor([900.0, 500.0, 2.0, 190.0])
        new_pos = torch.Tensor([890.0, 490.0, 1.9, 185.0])
        mean_init, covariance_init = kf.initiate(det_box)
        self.assertTrue(
            abs(
                (
                    mean_init
                    - torch.Tensor([900.0, 500.0, 2.0, 190.0])
                ).sum()
            )
            < 1e-4
        )
        self.assertTrue(
            abs(
                (
                    covariance_init
                    - torch.Tensor(
                    [
                        [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
                    ]
                    )
                ).sum()
            )
            < 1e-4
        )

        mean_predict, covariance_predict = kf.predict(
            mean_init, covariance_init
        )
        self.assertTrue(
            abs(
                (
                    mean_predict
                    - torch.Tensor(
                        [
                            900.0,
                            500.0,
                            2.0,
                            190.0,
                            0.0,
                            0.0,
                            0.0,
                            0.0,
                        ]
                    )
                ).sum()
            )
            < 1e-4
        )
        self.assertTrue(
            abs(
                (
                    covariance_predict
                    - torch.Tensor(
                    [
                        [
                            3.0,
                            0.0,
                            0.0,
                            0.0,
                            1.0,
                            0.0,
                            0.0,
                            0.0,
                        ],
                        [
                            0.0,
                            3.0,
                            0.0,
                            0.0,
                            0.0,
                            1.0,
                            0.0,
                            0.0,
                        ],
                        [
                            0.0,
                            0.0,
                            3.0,
                            0.0,
                            0.0,
                            0.0,
                            1.0,
                            0.0,
                        ],
                        [
                            0.0,
                            0.0,
                            0.0,
                            3.0,
                            0.0,
                            0.0,
                            0.0,
                            1.0,
                        ],
                        [
                            1.0,
                            0.0,
                            0.0,
                            0.0,
                            2.0,
                            0.0,
                            0.0,
                            0.0,
                        ],
                        [
                            0.0,
                            1.0,
                            0.0,
                            0.0,
                            0.0,
                            2.0,
                            0.0,
                            0.0,
                        ],
                        [
                            0.0,
                            0.0,
                            1.0,
                            0.0,
                            0.0,
                            0.0,
                            2.0,
                            0.0,
                        ],
                        [
                            0.0,
                            0.0,
                            0.0,
                            1.0,
                            0.0,
                            0.0,
                            0.0,
                            2.0,
                        ],
                    ]
                    )
                ).sum()
            )
            < 1e-4
        )

        mean_update, covariance_update = kf.update(
            mean_predict,
            covariance_predict,
            new_pos,
        )
        self.assertTrue(
            abs(
                (
                    mean_update
                    - torch.Tensor(
                        [
                            8.9250e+02,
                            4.9400e+02,
                            1.9500e+00,
                            1.8786e+02,
                            -2.5000e+00,
                            -2.0000e+00,
                            -1.6667e-02,
                            -7.1429e-01,
                        ]
                    )
                ).sum()
            )
            < 1e-4
        )
        self.assertTrue(
            abs(
                (
                    covariance_update
                    - torch.Tensor(
                    [
                        [
                            0.75,
                            0.0,
                            0.0,
                            0.0,
                            0.25,
                            0.0,
                            0.0,
                            0.0,
                        ],
                        [
                            0.0,
                            1.2,
                            0.0,
                            0.0,
                            0.0,
                            0.4,
                            0.0,
                            0.0,
                        ],
                        [
                            0.0,
                            0.0,
                            1.5,
                            0.0,
                            0.0,
                            0.0,
                            0.5,
                            0.0,
                        ],
                        [
                            0.0,
                            0.0,
                            0.0,
                            1.7143,
                            0.0,
                            0.0,
                            0.0,
                            0.5714,
                        ],
                        [
                            0.25,
                            0.0,
                            0.0,
                            0.0,
                            1.75,
                            0.0,
                            0.0,
                            0.0,
                        ],
                        [
                            0.0,
                            0.4,
                            0.0,
                            0.0,
                            0.0,
                            1.8,
                            0.0,
                            0.0,
                        ],
                        [
                            0.0,
                            0.0,
                            0.5,
                            0.0,
                            0.0,
                            0.0,
                            1.8333,
                            0.0,
                        ],
                        [
                            0.0,
                            0.0,
                            0.0,
                            0.5714,
                            0.0,
                            0.0,
                            0.0,
                            1.8571,
                        ],
                    ]
                    )
                ).sum()
            )
            < 1e-4
        )
    def test_kalman_dimension(self) -> None:
        """Test cases for 3 dimension measurement kalman filter."""
        kf_motion_mat = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 1.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
            ]
        )
        kf_update_mat = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
            ]
        )
        cov_motion_q = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 1.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
            ]
        )
        cov_project_r = torch.Tensor(
            [
                [1.1569e01, 0.0000e00, 0.0000e00],
                [0.0000e00, 7.9620e00, 0.0000e00],
                [0.0000e00, 0.0000e00, 2.9381e-02],
            ]
        )
        cov_p0 = torch.Tensor(
            [
                [
                    8.6435e04,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    7.0400e03,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    5.9936e-01,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    5.3149e03,
                    0.0000e00,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    7.4345e02,
                    0.0000e00,
                ],
                [
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    0.0000e00,
                    6.2898e01,
                ],
            ]
        )
        kf = KalmanFilter(
            kf_motion_mat,
            kf_update_mat,
            cov_motion_q,
            cov_project_r,
            cov_p0,
        )

        det_box = torch.Tensor([979.5134, 545.2235, 1.3536])
        new_pos = torch.Tensor([975.5881, 539.7464, 1.3721])

        mean_init, covariance_init = kf.initiate(det_box)

        self.assertTrue(
            abs(
                (
                    mean_init
                    - torch.Tensor(
                        [
                            979.5134,
                            545.2235,
                            1.3536,
                            0.0000,
                            0.0000,
                            0.0000,
                        ]
                    )
                ).sum()
            )
            < 1e-4
        )
        self.assertTrue(
            abs(
                (
                    covariance_init
                    - torch.Tensor(
                        [
                            [
                                8.6435e04,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                7.0400e03,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                5.9936e-01,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                5.3149e03,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                7.4345e02,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                6.2898e01,
                            ],
                        ]
                    )
                ).sum()
            )
            < 1e-4
        )
        mean_predict, covariance_predict = kf.predict(
            mean_init, covariance_init
        )
        self.assertTrue(
            abs(
                (
                    mean_predict
                    - torch.Tensor(
                        [
                            979.5134,
                            545.2235,
                            1.3536,
                            0.0000,
                            0.0000,
                            0.0000,
                        ]
                    )
                ).sum()
            )
            < 1e-4
        )
        self.assertTrue(
            abs(
                (
                    covariance_predict
                    - torch.Tensor(
                        [
                            [
                                8.7309e04,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                7.4345e02,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                7.1845e03,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                6.2898e01,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                7.4751e-01,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                5.5042e03,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                7.4345e02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                8.7397e02,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                6.2898e01,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                1.4447e02,
                            ],
                        ]
                    )
                ).sum()
            )
            < 1e-4
        )
        mean_update, covariance_update = kf.update(
            mean_predict,
            covariance_predict,
            new_pos,
        )
        self.assertTrue(
            abs(
                (
                    mean_update
                    - torch.Tensor(
                        [
                            9.7559e02,
                            5.3975e02,
                            1.3714e00,
                            0.0000e00,
                            -3.3421e-02,
                            -4.7897e-02,
                        ]
                    )
                ).sum()
            )
            < 1e-4
        )
        self.assertTrue(
            abs(
                (
                    covariance_update
                    - torch.Tensor(
                        [
                            [
                                1.1555e01,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                9.8389e-02,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                7.9521e00,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                6.9618e-02,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                2.8270e-02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                5.5042e03,
                                0.0000e00,
                                0.0000e00,
                            ],
                            [
                                9.8389e-02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                8.6764e02,
                                0.0000e00,
                            ],
                            [
                                0.0000e00,
                                6.9618e-02,
                                0.0000e00,
                                0.0000e00,
                                0.0000e00,
                                1.4392e02,
                            ],
                        ]
                    )
                ).sum()
            )
            < 1e-4
        )
