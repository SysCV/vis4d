"""Test cases for kalman filter."""
import unittest

import torch

from .kalman_filter import KalmanFilter


class TestKalmanFilter(unittest.TestCase):
    """Test cases for kalman filter."""

    def test_kalman(self) -> None:
        """Test cases for kalman filter."""
        kf_motion_mat = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0],
                [0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
            ]
        )
        kf_update_mat = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
            ]
        )
        cov_motion_q = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
            ]
        )
        cov_project_r = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0],
                [0.0, 2.0, 0.0, 0.0],
                [0.0, 0.0, 3.0, 0.0],
                [0.0, 0.0, 0.0, 4.0],
            ]
        )
        cov_p0 = torch.Tensor(
            [
                [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
            ]
        )

        kf = KalmanFilter(
            kf_motion_mat,
            kf_update_mat,
            cov_motion_q,
            cov_project_r,
            cov_p0,
        )

        det_box = torch.Tensor([900.0, 500.0, 2.0, 190.0])
        new_pos = torch.Tensor([890.0, 490.0, 1.9, 185.0])
        mean_init, covariance_init = kf.initiate(det_box)
        self.assertTrue(
            abs(
                (
                    mean_init
                    - torch.Tensor(
                        [900.0, 500.0, 2.0, 190.0, 0.0, 0.0, 0.0, 0.0]
                    )
                ).sum()
            )
            < 1e-2
        )
        self.assertTrue(
            abs(
                (
                    covariance_init
                    - torch.Tensor(
                        [
                            [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                            [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                            [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                            [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                            [0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                            [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
                        ]
                    )
                ).sum()
            )
            < 1e-2
        )

        mean_predict, covariance_predict = kf.predict(
            mean_init, covariance_init
        )
        self.assertTrue(
            abs(
                (
                    mean_predict
                    - torch.Tensor(
                        [
                            900.0,
                            500.0,
                            2.0,
                            190.0,
                            0.0,
                            0.0,
                            0.0,
                            0.0,
                        ]
                    )
                ).sum()
            )
            < 1e-2
        )
        self.assertTrue(
            abs(
                (
                    covariance_predict
                    - torch.Tensor(
                        [
                            [
                                3.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                            ],
                            [
                                0.0,
                                3.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                0.0,
                                0.0,
                            ],
                            [
                                0.0,
                                0.0,
                                3.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                0.0,
                            ],
                            [
                                0.0,
                                0.0,
                                0.0,
                                3.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                            ],
                            [
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                2.0,
                                0.0,
                                0.0,
                                0.0,
                            ],
                            [
                                0.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                2.0,
                                0.0,
                                0.0,
                            ],
                            [
                                0.0,
                                0.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                2.0,
                                0.0,
                            ],
                            [
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                2.0,
                            ],
                        ]
                    )
                ).sum()
            )
            < 1e-2
        )

        mean_update, covariance_update = kf.update(
            mean_predict,
            covariance_predict,
            new_pos,
        )
        self.assertTrue(
            abs(
                (
                    mean_update
                    - torch.Tensor(
                        [
                            8.9250e02,
                            4.9400e02,
                            1.9500e00,
                            1.8786e02,
                            -2.5000e00,
                            -2.0000e00,
                            -1.6667e-02,
                            -7.1429e-01,
                        ]
                    )
                ).sum()
            )
            < 1e-2
        )
        self.assertTrue(
            abs(
                (
                    covariance_update
                    - torch.Tensor(
                        [
                            [
                                0.7500,
                                0.0000,
                                0.0000,
                                0.0000,
                                0.2500,
                                0.0000,
                                0.0000,
                                0.0000,
                            ],
                            [
                                0.0000,
                                1.2000,
                                0.0000,
                                0.0000,
                                0.0000,
                                0.4000,
                                0.0000,
                                0.0000,
                            ],
                            [
                                0.0000,
                                0.0000,
                                1.5000,
                                0.0000,
                                0.0000,
                                0.0000,
                                0.5000,
                                0.0000,
                            ],
                            [
                                0.0000,
                                0.0000,
                                0.0000,
                                1.7143,
                                0.0000,
                                0.0000,
                                0.0000,
                                0.5714,
                            ],
                            [
                                0.2500,
                                0.0000,
                                0.0000,
                                0.0000,
                                1.7500,
                                0.0000,
                                0.0000,
                                0.0000,
                            ],
                            [
                                0.0000,
                                0.4000,
                                0.0000,
                                0.0000,
                                0.0000,
                                1.8000,
                                0.0000,
                                0.0000,
                            ],
                            [
                                0.0000,
                                0.0000,
                                0.5000,
                                0.0000,
                                0.0000,
                                0.0000,
                                1.8333,
                                0.0000,
                            ],
                            [
                                0.0000,
                                0.0000,
                                0.0000,
                                0.5714,
                                0.0000,
                                0.0000,
                                0.0000,
                                1.8571,
                            ],
                        ]
                    )
                ).sum()
            )
            < 1e-2
        )
